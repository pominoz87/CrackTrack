<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Primary Rejects Underpan Screen Crack Catalogue</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* Two main view areas */
    #mainScreen, #equipmentScreen { display: none; }
    #mainScreen.active, #equipmentScreen.active { display: block; }
    .equipment-item { margin-bottom: 10px; }
    #canvasContainer {
      position: relative;
      display: inline-block;
      border: 1px solid #ccc;
    }
    canvas { cursor: pointer; }
    /* Instruction styling */
    #instructions { margin-top: 10px; padding: 10px; background: #f4f4f4; }
  </style>
</head>
<body>
  <!-- Main Index Screen -->
  <div id="mainScreen" class="active">
    <h1>Primary Rejects Underpan Screen Crack Catalogue</h1>
    <!-- Overview image -->
    <img src="MainImage.jpg" alt="Overview of Equipment Locations" style="max-width:100%;"><br><br>
    <!-- Instructions -->
    <div id="instructions">
      <strong>Instructions:</strong>
      <ol>
        <li>Select one of the four equipment pieces below. (Equipment names are fixed.)</li>
        <li>On the equipment detail screen, first upload the main (zoomed‑out) image for that equipment.</li>
        <li>Then click on the image where a crack is located to add a crack photo. If you click near an existing crack marker, you’ll be given the option to add another photo (with a note) or view existing details.</li>
        <li>Every crack location is automatically assigned a unique Crack ID, and any notes you add will be saved.</li>
        <li>Your data is stored locally so you can work offline and it will update once you’re back online.</li>
      </ol>
    </div>
    <br>
    <!-- Equipment selection (non-editable) -->
    <div class="equipment-item" data-index="0">
      <span id="eqName0">224CH308</span>
      <button onclick="selectEquipment(0)">Work on Equipment 224CH308</button>
    </div>
    <div class="equipment-item" data-index="1">
      <span id="eqName1">224CH306</span>
      <button onclick="selectEquipment(1)">Work on Equipment 224CH306</button>
    </div>
    <div class="equipment-item" data-index="2">
      <span id="eqName2">224CH326</span>
      <button onclick="selectEquipment(2)">Work on Equipment 224CH326</button>
    </div>
    <div class="equipment-item" data-index="3">
      <span id="eqName3">224CH328</span>
      <button onclick="selectEquipment(3)">Work on Equipment 224CH328</button>
    </div>
  </div>

  <!-- Equipment Detail Screen -->
  <div id="equipmentScreen">
    <button onclick="goBack()">Back to Equipment Selection</button>
    <h2 id="equipmentTitle"></h2>
    <p>Upload the main (GA/zoomed‑out) image for this equipment. Then click on areas to catalogue cracks.</p>
    <!-- Main equipment image upload -->
    <input type="file" id="mainImageInput" accept="image/*">
    <br><br>
    <div id="canvasContainer">
      <canvas id="mainCanvas"></canvas>
    </div>
    <br>
    <!-- Hidden input for crack images -->
    <input type="file" id="crackImageInput" accept="image/*" style="display:none">
  </div>

  <script>
    /***********************
     * Offline and Persistence Setup
     ***********************/
    // Service Worker inline code (using a Blob)
    var swCode = `
      const CACHE_NAME = 'crack-catalogue-cache-v1';
      const urlsToCache = [
        '/',
        '/index.html',
        '/MainImage.jpg'
      ];
      self.addEventListener('install', function(event) {
        event.waitUntil(
          caches.open(CACHE_NAME).then(function(cache) {
            console.log('Opened cache');
            return cache.addAll(urlsToCache);
          })
        );
      });
      self.addEventListener('fetch', function(event) {
        event.respondWith(
          caches.match(event.request).then(function(response) {
            return response || fetch(event.request);
          })
        );
      });
      self.addEventListener('activate', function(event) {
        event.waitUntil(
          caches.keys().then(function(cacheNames) {
            return Promise.all(
              cacheNames.map(function(cacheName) {
                if (cacheName !== CACHE_NAME) {
                  return caches.delete(cacheName);
                }
              })
            );
          })
        );
      });
    `;
    if ('serviceWorker' in navigator) {
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swBlobUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swBlobUrl).then(function(registration) {
        console.log('ServiceWorker registered with scope: ', registration.scope);
      }).catch(function(error) {
        console.log('ServiceWorker registration failed: ', error);
      });
    }

    // Local persistence: Save and load data from localStorage.
    function saveData() {
      localStorage.setItem("equipmentList", JSON.stringify(equipmentList));
      localStorage.setItem("crackCounter", crackCounter);
    }
    function loadData() {
      const storedEquipment = localStorage.getItem("equipmentList");
      if(storedEquipment) {
        equipmentList = JSON.parse(storedEquipment);
      }
      const storedCounter = localStorage.getItem("crackCounter");
      crackCounter = storedCounter ? parseInt(storedCounter, 10) : 1;
    }

    /***********************
     * Global Data and Variables
     ***********************/
    // Define four equipment items with fixed names.
    var equipmentList = [
      { name: "224CH308", mainImage: null, markers: [] },
      { name: "224CH306", mainImage: null, markers: [] },
      { name: "224CH326", mainImage: null, markers: [] },
      { name: "224CH328", mainImage: null, markers: [] }
    ];
    var currentEquipmentIndex = null; // Which equipment is active
    var currentMarkerIndex = null;      // For adding to an existing marker
    var crackCounter = 1; // Global counter to assign unique Crack IDs

    // Try loading any saved data on page load.
    loadData();

    /***********************
     * Element References
     ***********************/
    var mainScreen = document.getElementById('mainScreen');
    var equipmentScreen = document.getElementById('equipmentScreen');
    var equipmentTitle = document.getElementById('equipmentTitle');
    var mainImageInput = document.getElementById('mainImageInput');
    var crackImageInput = document.getElementById('crackImageInput');
    var canvas = document.getElementById('mainCanvas');
    var ctx = canvas.getContext('2d');
    var mainImage = new Image();

    /***********************
     * Equipment Selection Functions
     ***********************/
    function selectEquipment(index) {
      currentEquipmentIndex = index;
      equipmentTitle.textContent = equipmentList[index].name;
      // Switch view: hide mainScreen, show equipmentScreen.
      mainScreen.classList.remove('active');
      equipmentScreen.classList.add('active');
      // Load the main image if available; otherwise, initialize a blank canvas.
      if(equipmentList[index].mainImage) {
        mainImage.src = equipmentList[index].mainImage;
      } else {
        mainImage = new Image();
        canvas.width = 600;
        canvas.height = 400;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      mainImage.onload = function(){
        canvas.width = mainImage.width;
        canvas.height = mainImage.height;
        drawCanvas();
      };
    }

    function goBack() {
      // Save the current main image into the equipment data.
      if(currentEquipmentIndex !== null) {
        equipmentList[currentEquipmentIndex].mainImage = mainImage.src;
      }
      saveData();
      currentEquipmentIndex = null;
      mainScreen.classList.add('active');
      equipmentScreen.classList.remove('active');
    }

    /***********************
     * Equipment Detail Functions
     ***********************/
    // Upload a new main image for the equipment.
    mainImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          mainImage.src = event.target.result;
          if(currentEquipmentIndex !== null) {
            equipmentList[currentEquipmentIndex].mainImage = mainImage.src;
            saveData();
          }
        };
        reader.readAsDataURL(file);
      }
    });

    // Redraw the canvas with the main image and markers.
    function drawCanvas() {
      if(mainImage.src) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(mainImage, 0, 0);
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      if(currentEquipmentIndex !== null) {
        var markers = equipmentList[currentEquipmentIndex].markers;
        markers.forEach(marker => {
          ctx.beginPath();
          ctx.arc(marker.x, marker.y, 10, 0, Math.PI * 2);
          ctx.strokeStyle = 'red';
          ctx.lineWidth = 2;
          ctx.stroke();
          // Optionally, draw the Crack ID near the marker.
          ctx.font = "12px Arial";
          ctx.fillStyle = "red";
          ctx.fillText(marker.crackID, marker.x + 12, marker.y + 4);
        });
      }
    }

    // Handle clicks on the canvas to add or view crack photos.
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      if(currentEquipmentIndex === null) return;
      let markers = equipmentList[currentEquipmentIndex].markers;
      // Check if click is near an existing marker (within 15px).
      for(let i = 0; i < markers.length; i++){
        let marker = markers[i];
        const dx = marker.x - clickX;
        const dy = marker.y - clickY;
        if(Math.sqrt(dx*dx + dy*dy) <= 15){
          // Existing marker found.
          if(confirm("Crack " + marker.crackID + " already has " + marker.images.length + " photo(s) with notes.\nClick OK to add another photo, or Cancel to view details.")){
            currentMarkerIndex = i;
            crackImageInput.click();
          } else {
            viewMarkerDetails(marker);
          }
          return;
        }
      }
      // No marker near the click—create a new one.
      currentMarkerIndex = null;
      crackImageInput.dataset.x = clickX;
      crackImageInput.dataset.y = clickY;
      crackImageInput.click();
    });

    // Handle crack image upload (for both new markers and existing ones).
    crackImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = (event) => {
          let imageData = event.target.result;
          let note = prompt("Enter a note for this crack image:", "");
          if(currentEquipmentIndex === null) return;
          let markers = equipmentList[currentEquipmentIndex].markers;
          if(currentMarkerIndex !== null) {
            // Add to an existing marker.
            markers[currentMarkerIndex].images.push(imageData);
            markers[currentMarkerIndex].notes.push(note || "");
          } else {
            // Create a new marker with a unique Crack ID.
            let newMarker = {
              crackID: "CRACK-" + crackCounter++,
              x: parseFloat(crackImageInput.dataset.x),
              y: parseFloat(crackImageInput.dataset.y),
              images: [imageData],
              notes: [note || ""]
            };
            markers.push(newMarker);
          }
          drawCanvas();
          saveData();
        };
        reader.readAsDataURL(file);
      }
    });

    // Open a new window showing all images, Crack ID, and notes for a marker.
    function viewMarkerDetails(marker) {
      let html = "<html><head><title>Crack " + marker.crackID + " Details</title></head><body>";
      html += "<h2>Crack ID: " + marker.crackID + "</h2>";
      marker.images.forEach((imgData, index) => {
        html += "<div><p>Photo " + (index+1) + " (Note: " + (marker.notes[index] || "No note") + "):</p>";
        html += "<img src='" + imgData + "' style='max-width:100%;'/></div><hr>";
      });
      html += "</body></html>";
      let win = window.open("", "Crack Details", "width=600,height=600");
      win.document.write(html);
    }
  </script>
</body>
</html>
